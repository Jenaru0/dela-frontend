# ğŸš€ CI/CD Frontend - Dokploy Deploy
# Pipeline optimizado para frontend/production con validaciones y deploy automÃ¡tico

name: ğŸš€ Frontend CI/CD - Dokploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente

env:
  NODE_VERSION: '18'
  WORKING_DIR: 'web'

jobs:
  # âœ… Validaciones y Tests
  validate:
    name: âœ… Validar CÃ³digo
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package.json'

      - name: ğŸ“¦ Instalar Dependencias
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: ğŸ” Lint CÃ³digo
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run lint

      - name: ğŸ”§ Verificar Tipos TypeScript
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run type-check

      - name: ğŸ§ª Ejecutar Tests (si existen)
        working-directory: ${{ env.WORKING_DIR }}
        run: npm test --passWithNoTests || echo "No hay tests configurados"

  # ğŸ—ï¸ Build y Deploy
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package.json'

      - name: ğŸ“¦ Instalar Dependencias
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: ğŸ—ï¸ Build AplicaciÃ³n
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run build

      - name: ğŸ“Š Analizar Bundle (opcional)
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“¦ TamaÃ±o del build:"
          du -sh .next/ || echo "Build directory no encontrado"

      - name: âœ… Preparar Deploy
        run: |
          echo "âœ… Frontend build completado exitosamente"
          echo "ğŸš€ Dokploy detectarÃ¡ este push automÃ¡ticamente"
          echo "ğŸ”— Monitorea el progreso en tu dashboard de Dokploy"
          echo "ğŸ“… Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deploy iniciado por: ${{ github.actor }}"
          echo "ğŸ• Tiempo: $(date)"

  # ğŸš€ NotificaciÃ³n de Deploy
  notify-deploy:
    name: ğŸ“¢ Notificar Deploy
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always() && needs.build-and-deploy.result == 'success'

    steps:
      - name: ğŸ‰ Deploy Exitoso
        run: |
          echo "ğŸ‰ Â¡Deploy completado exitosamente!"
          echo "ğŸŒ La aplicaciÃ³n deberÃ­a estar disponible pronto"
          echo "â±ï¸ Tiempo estimado de propagaciÃ³n: 2-5 minutos"
          echo "ğŸ”— Verifica tu dominio de producciÃ³n"
