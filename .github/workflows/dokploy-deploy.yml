# ğŸš€ Auto-Deploy a Dokploy
# Despliega automÃ¡ticamente cuando se hace push a las ramas de producciÃ³n

name: ğŸš€ Deploy to Dokploy

on:
  push:
    branches:
      - frontend/production
      - backend/production
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/frontend/production'

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Trigger Dokploy Frontend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_FRONTEND_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.DOKPLOY_FRONTEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "refs/heads/frontend/production",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
          else
            echo "âš ï¸ DOKPLOY_FRONTEND_WEBHOOK no configurado. Saltando deploy automÃ¡tico."
            echo "âœ… Frontend build verificado correctamente"
          fi

      - name: âœ… Frontend Deploy Triggered
        run: |
          echo "âœ… Frontend deploy iniciado en Dokploy"
          echo "ğŸ”— Monitorea el progreso en tu dashboard de Dokploy"

  deploy-backend:
    name: ğŸ”§ Deploy Backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/backend/production'

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Trigger Dokploy Backend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "refs/heads/backend/production",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
          else
            echo "âš ï¸ DOKPLOY_BACKEND_WEBHOOK no configurado. Saltando deploy automÃ¡tico."
            echo "âœ… Backend build verificado correctamente"
          fi

      - name: âœ… Backend Deploy Triggered
        run: |
          echo "âœ… Backend deploy iniciado en Dokploy"
          echo "ğŸ”— Monitorea el progreso en tu dashboard de Dokploy"

  notify-success:
    name: ğŸ“¢ Notificar Ã‰xito
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-backend.result == 'success')

    steps:
      - name: ğŸ‰ Deploy Completado
        run: |
          echo "ğŸ‰ Deploy completado exitosamente"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Usuario: ${{ github.actor }}"
