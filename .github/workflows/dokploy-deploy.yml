# ðŸš€ Auto-Deploy a Dokploy
# Despliega automÃ¡ticamente cuando se hace push a las ramas de producciÃ³n

name: ðŸš€ Deploy to Dokploy

on:
  push:
    branches:
      - frontend/production
      - backend/production
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/frontend/production'

    steps:
      - name: ðŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸš€ Trigger Dokploy Frontend Deploy
        run: |
          curl -X POST "${{ secrets.DOKPLOY_FRONTEND_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "ref": "refs/heads/frontend/production",
              "repository": {
                "full_name": "${{ github.repository }}"
              },
              "commits": [{
                "message": "${{ github.event.head_commit.message }}",
                "id": "${{ github.sha }}"
              }]
            }'

      - name: âœ… Frontend Deploy Triggered
        run: |
          echo "âœ… Frontend deploy iniciado en Dokploy"
          echo "ðŸ”— Monitorea el progreso en tu dashboard de Dokploy"

  deploy-backend:
    name: ðŸ”§ Deploy Backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/backend/production'

    steps:
      - name: ðŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸš€ Trigger Dokploy Backend Deploy
        run: |
          curl -X POST "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "ref": "refs/heads/backend/production",
              "repository": {
                "full_name": "${{ github.repository }}"
              },
              "commits": [{
                "message": "${{ github.event.head_commit.message }}",
                "id": "${{ github.sha }}"
              }]
            }'

      - name: âœ… Backend Deploy Triggered
        run: |
          echo "âœ… Backend deploy iniciado en Dokploy"
          echo "ðŸ”— Monitorea el progreso en tu dashboard de Dokploy"

  notify-success:
    name: ðŸ“¢ Notificar Ã‰xito
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-backend.result == 'success')

    steps:
      - name: ðŸŽ‰ Deploy Completado
        run: |
          echo "ðŸŽ‰ Deploy completado exitosamente"
          echo "ðŸ“… Fecha: $(date)"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Usuario: ${{ github.actor }}"
